# ğŸ“˜ ë°ì´í„° êµ¬ì„± ë° ì‹¤í–‰ ê°€ì´ë“œ

## ğŸ“‚ ë°ì´í„° êµ¬ì„± ë° í…Œì´ë¸” ì„¤ëª…

| **ë°ì´í„° ê³„ì—´**    | **êµ¬ì„± í…Œì´ë¸”**                      | **ì„¤ëª…**                                                                                                                                        |
| ------------------ | ------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| **qpoll ê³„ì—´**     | `metadata`, `respondents`, `answers` | ì¸êµ¬í†µê³„ ì •ë³´(`metadata`) + ì‘ë‹µ ë‚´ìš©(`answers`) ëª¨ë‘ ì¡´ì¬.<br>`respondents`ëŠ” íŒ¨ë„ ID(`mb_sn`)ì™€ ë²¡í„° ì €ì¥ìš©ìœ¼ë¡œ ì‚¬ìš©.                         |
| **welcome_1st**    | `respondents`, `metadata`            | ì§€ì—­Â·ë‚˜ì´ ë“± ê¸°ë³¸ ì†ì„±ë§Œ ì¡´ì¬ â†’ ë³„ë„ì˜ `answers` ë¶ˆí•„ìš”.<br>`respondents`ë¡œ ì‹ë³„, `metadata`ì— ì‘ë‹µ ë‚´ìš© ì €ì¥.<br>(1stì˜ ì‘ë‹µë‚´ìš© = `metadata`) |
| **welcome_2nd**    | `respondents`, `answers`             | ë¬¸í•­ ì¤‘ì‹¬ ì‘ë‹µ ë°ì´í„°ë§Œ ì¡´ì¬ â†’ `metadata` ì—†ì´ `answers`ë¡œ ê´€ë¦¬.                                                                                |
| **ê³µí†µ ë¬¸í•­ ì •ë³´** | `codebooks`                          | ëª¨ë“  íŒŒì¼ì˜ ë¬¸í•­(`Q1~Qn`)ê³¼ ë³´ê¸° ì •ë³´ë¥¼ í†µí•© ê´€ë¦¬.<br>`answers`ì™€ `question_id` ê¸°ì¤€ìœ¼ë¡œ ì—°ê²°.                                                  |

---

## ğŸ§± í…Œì´ë¸” êµ¬ì¡°

| **í…Œì´ë¸”ëª…**  | **ì»¬ëŸ¼ëª…**                                                                       | **ì„¤ëª…**                                                           |
| ------------- | -------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| `respondents` | `mb_sn`, `profile_vector`                                                        | ê³ ìœ  íŒ¨ë„ ë²ˆí˜¸(`mb_sn`), í”„ë¡œí•„ ë²¡í„°(`p_vector`)                   |
| `answers`     | `answer_id`, `mb_sn`, `question_id`, `answer_value`, `a_vector`                  | ì‘ë‹µ ì‹ë³„ì, ì‘ë‹µì ë²ˆí˜¸, ì½”ë“œë¶ ë‚´ ë¬¸í•­ ë²ˆí˜¸, ë‹µë³€ê°’, ë‹µë³€ ì„ë² ë”© |
| `metadata`    | `metadata_id`, `mb_sn`, `mobile_carrier`, `gender`, `birth_year`,`age`, `region` | ì¸êµ¬í†µê³„ ë©”íƒ€ë°ì´í„° (ì´ë™í†µì‹ ì‚¬, ì„±ë³„, íƒœì–´ë‚œí•´, ì—°ë ¹, ì§€ì—­ ë“±)    |
| `codebooks`   | `codebook_id`, `codebook_data (jsonb)`, `q_vector`                               | ì½”ë“œë¶ íŒŒì¼ ID, ë¬¸í•­ ë‚´ìš©(JSONB í˜•ì‹), ë¬¸í•­ ì„ë² ë”© ë²¡í„°            |

---

## âš™ï¸ ì½”ë“œ ì‹¤í–‰ ìˆœì„œ

> âš ï¸ _requirements.txtì˜ ëª¨ë“  íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤._

> âš ï¸ _.envë¥¼ ì‘ì„±í•œ ì½”ë“œì— ë§ê²Œ ì¶”ê°€&ìˆ˜ì •í•´ì£¼ì„¸ìš”._

- DB_HOST = # ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ ì£¼ì†Œ
- DB_PORT = # ë°ì´í„°ë² ì´ìŠ¤ í¬íŠ¸
- DB_NAME = # ì—°ê²°í•  ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
- DB_USER = # ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ID
- DB_PASSWORD = # ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë³´ì•ˆì— ìœ ì˜)
- INPUT_PATH = # ë°ì´í„°ë“¤ì´ ìˆëŠ” í´ë”/ë””ë ‰í„°ë¦¬ ê²½ë¡œ(** ì ˆëŒ€ ê²½ë¡œ  **)

# ì›ë³¸ íŒŒì¼ë“¤ì´ ë“¤ì–´ìˆëŠ” í´ë” ê²½ë¡œ

INPUT_FOLDER = os.getenv('INPUT_PATH')

---

### 1ï¸âƒ£ ë°ì´í„° íŒŒì¼ ì¤€ë¹„

#### ğŸ§© Qpoll ê³„ì—´

- ë°ì´í„° ê²½ë¡œ: ./Data/db_insert/panelData/

#### ğŸ§© Welcome 1st / 2nd ê³„ì—´

- ìœ„ì™€ ë™ì¼í•˜ê²Œ ì‹¤í–‰
- ë‹¨, **íŒŒì¼ í™•ì¥ìëŠ” `.csv`**
- ì½”ë“œë¶(`welcome_*_codebook.csv` ë“±)ì´ ìˆë‹¤ë©´ í•¨ê»˜ ë³µì‚¬í•´ì•¼ í•¨

---

### 2ï¸âƒ£ ë°ì´í„° ì‚½ì… ì½”ë“œ ìˆ˜ì •

| **íŒŒì¼ëª…**                       | **ìˆ˜ì • í•­ëª©**                                  |
| -------------------------------- | ---------------------------------------------- |
| `insert_1st.py`, `insert_2nd.py` | ë°ì´í„° íŒŒì¼ ê²½ë¡œ ë° íŒŒì¼ëª…, DB ì„¤ì •ê°’          |
| `insert_qpoll.py`                | ì‹¤í–‰ ê²½ë¡œ ê¸°ì¤€ìœ¼ë¡œ íŒŒì¼ ê²½ë¡œ ë° DB ì„¤ì •ê°’ ìˆ˜ì • |
| `drop_table.py`                  | DBì´ˆê¸°í™”(ëª¨ë“  í…Œì´ë¸” DROP)                     |

---

### 3ï¸âƒ£ ë°ì´í„° ì‚½ì… ì‹¤í–‰

```bash
python ./Data/db_insert/insert_all.py
* ./Data/db_insert/drop_table.py ëŠ” ëª¨ë“  í…Œì´ë¸”ì„ DROPí•˜ëŠ” ì½”ë“œì„ìœ¼ë¡œ.. insert_all.py ì‹¤í–‰ì‹œ ì´ˆê¸°í™” ëª©ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë‹ˆ ì› DBë¥¼ ìœ ì§€ ì›í•  ì‹œ ì´ë¥¼ ì£¼ì„ì²˜ë¦¬ í•´ì•¼í•¨! *

4ï¸âƒ£ ì„ë² ë”© ì‹¤í–‰
python ./embedding/embedding.py
python ./embedding/profileVector.py

5ï¸âƒ£ PostgreSQL ê²€ìˆ˜

psql í™˜ê²½ì—ì„œ ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì‚½ì…ë˜ê³ 
ì„ë² ë”©(p_vector, a_vector, q_vector)ì´ ì˜ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸.

```

### 6ï¸âƒ£ ë‹¤ì¤‘ ì¡°ê±´ í•„í„° & ì˜ë¯¸ê¸°ë°˜ ì§ˆì˜(semantic query) íŒŒì‹± ê¸°ëŠ¥

í…ŒìŠ¤íŠ¸

```bash
python ./Data/search/parsing.py

* ì˜ˆì‹œë¡œ ë“¤ì–´ê°„ í…ŒìŠ¤íŠ¸ ë¬¸ì´ jsoní™” ëœ í•„í„°ì™€ ì§ˆì˜ë¥¼ ë¶„ë¦¬í•˜ì—¬ ë°˜í™˜í•¨.*
{
  "filters": [
    {
      "column": "region",
      "operator": "LIKE",
      "value": "ì„œìš¸%"
    },
    {
      "column": "region",
      "operator": "LIKE",
      "value": "ê²½ê¸°ë„%"
    },
    {
      "column": "age",
      "operator": ">=",
      "value": "40"
    },
    {
      "column": "age",
      "operator": "<",
      "value": "50"
    },
    {
      "column": "gender",
      "operator": "=",
      "value": "ì—¬ì„±"
    },
    {
      "column": "mobile_carrier",
      "operator": "=",
      "value": "LG"
    }
  ],
  "semantic_query": "ë¬¸í™”ìƒí™œ ë§Œì¡±ë„"
```

### 7ï¸âƒ£ í•„í„° ê¸°ë°˜ìœ¼ë¡œ ë™ì  SQLë¬¸ ì‘ì„± ê¸°ëŠ¥(makeSQL.py)

```bash

python ./Data/search/makeSQL.py

í•´ë‹¹ íŒŒì´ì¬ ì½”ë“œ ë‚´ í•¨ìˆ˜ ì‚¬ìš©
build_metadata_where_clause(filters_list, table_name="metadata")

í•„í„° ì˜ˆì‹œ:
"filters": [
    {
      "column": "region",
      "operator": "LIKE",
      "value": "ì„œìš¸%"
    },
    {
      "column": "gender",
      "operator": "=",
      "value": "ë‚¨ì„±"
    },
    {
      "column": "gender",
      "operator": "=",
      "value": "ì—¬ì„±"
    }
  ],
  "semantic_query": "ìš´ë™ì„ ì¢‹ì•„í•˜ëŠ”"

  ì‹¤í–‰ê²°ê³¼ â¬‡ï¸

  ìƒì„±ëœ ì¿¼ë¦¬ (psycopg2ìš©): SELECT mb_sn FROM metadata WHERE (region LIKE %s) AND (gender = %s OR gender = %s);
  ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° (psycopg2ìš©): ['ì„œìš¸%', 'ë‚¨ì„±', 'ì—¬ì„±']
```

### 8ï¸âƒ£ ë°±ì—”ë“œì—ì„œ ë°›ì€ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ AI ìš”ì•½ ê¸°ëŠ¥ ì œê³µ

```bash

  python ./Data/search/ai_summary.py

  ì˜ˆì‹œ ìë£Œ:
  "query_results": {
        "w2_Q5_1": {
          "q_title": "ì§ë¬´",
          "codebook_id": "w2_Q5_1",
          "value_counts": {
            "total_responses": 1877,
            "ìƒì‚°â€¢ì •ë¹„â€¢ê¸°ëŠ¥â€¢ë…¸ë¬´": 233,
            "ë””ìì¸": 23,
            "ê±´ì„¤â€¢ê±´ì¶•â€¢í† ëª©â€¢í™˜ê²½": 143,
            .
            .
            .
          }
        }
  }

í•´ë‹¹ ì½”ë“œë‚´ summarize_agg_results(user_query: str, agg_results: dict) í•¨ìˆ˜ ì‚¬ìš©

ì´í›„ OpenAIì˜ gpt ëª¨ë¸(ê°œì¸ ì„¤ì •)ì— ë”°ë¼ ì œê³µí•œ AI ìš”ì•½ ê¸°ëŠ¥ ì œê³µ

```


## 6, 7, 8ì€ ë°±ì—”ë“œì— ì½”ë“œë¡œì„œ ë‚´ì¥ë˜ì–´ìˆìŒ
